# 灯質コード仕様

## 構文サマリー

```
<Type>[ (<count>)]  <color tokens>  [<period>s]
```

- **Type** &mdash; `Fl` / `Oc` / `Iso` / `Al` / `Dir` / `F` / `Gp Fl` / `Gp Oc` / `LFl` / `FFl` / `Fl F` / `Q` / `VQ` / `UQ` / `IQ` / `Mo` など、灯台表に記載される代表的な略号（大文字小文字は不問）。`Gp Fl` は群閃、`Gp Oc` は群明暗、`LFl` は長閃光、`FFl` は不動光＋閃光の重畳、`F` は不動光、`Mo` はモールス符号灯を表す。
- **Count** &mdash; 省略可能な整数。また `Fl(2+1)` のように足し算を並べて「最初の色を 2 回、次の色を 1 回」のようなシーケンスを明示することもある。`Fl` の場合は 1 周期に含まれる発光回数や色ごとの割り当て、`Al` の場合は色の切り替え回数を表す。`Dir` は方向別の色分けを示すためカウント指定を行わない。`Oc` と `Iso` もカウントを取らない。
- **Color tokens** &mdash; `W`（白）、`R`（赤）、`G`（緑）、`Y`（黄）をスペース区切りで並べる。航空標識との連携を見据えて `Am`（琥珀）も予約済みで、入力に含まれていれば単色扱いできる。`Al Fl W R` のように `Al` の直後に現れる `Fl` は、「交互点滅 (Al) の中身がフラッシュ列である」ことを示すラベルで、色トークンではない。`Al Iso ...` は交互等明暗灯、`Al Oc ...` は交互明暗灯を意味する（例: `Al Iso W G 6s`）。`Fl W R G` のように複数色を記述した場合、まずデータ側で `arcs` が用意されていれば各色を方位セクターに割り当て、方位に応じて色が切り替わる「セクター色」と解釈する。`arcs` が存在しない場合のみ、同一タイミングで複数色を同時発光させ、地図描画では混色ハイライト（3 色なら黄～白系）として示す。`Dir` の場合は常にセクター色として扱い、列挙した色それぞれに対応する方位セクターを `arcs` で指定する。
- **Period** &mdash; パターン 1 周期の長さを秒数で記述し、末尾に `s` を付ける（例: `16s`）。灯台表の規定に合わせ、原則として必ず値を指定する。`4.3s` のような小数も可。例外として、`Dir` と単独の `F`（不動光）は周期を省略可で、省略時は「常時点灯＝周期無し」とみなす。

例:

- `Fl(3) W 30s` &mdash; 30 秒周期で白色を 3 回発光。
- `Al Fl W R 16s` &mdash; 白と赤を 16 秒周期で交互に点灯。
- `Al Fl(2+1) W G 18s` &mdash; 白を 2 回点滅させた後に緑を 1 回点滅させ、交互パターンを 18 秒周期で繰り返す。
- `Al Oc W R 10s` &mdash; 交互明暗灯として白と赤の明暗シーケンスを 10 秒周期で切り替える。
- `F W` &mdash; 白色が常時点灯する不動光。港口灯台や指向灯で利用。
- `Gp Fl(3) W 15s` &mdash; 15 秒周期で白色の三連群閃。
- `LFl W 10s` &mdash; 10 秒周期で白色の長閃光。
- `Mo(A) W 6s` &mdash; 白色でモールス符号「A (・－)」を 6 秒周期で送信。
- `Dir F W R G` &mdash; 白・赤・緑の各セクターを持つ指向灯で、方位に応じて色が固定で見える。

## 色の扱い

- 使用できる色トークンは `W`（白）、`R`（赤）、`G`（緑）、`Y`（黄）。大文字・小文字は区別しない。`Am`（琥珀）は予約扱いで、将来的に航空標識や特別標識データを取り込む際に単色トークンとして解釈される。
- **単発の Fl**（`Fl` に数字が付かない場合）で複数色が並ぶと、`W/R` のようにスラッシュで結合した 1 トークンとして扱う。地図上では混色（例: `W/R` → オレンジ）で描画される。
- 多発光 (`Fl(n)`) や交互点灯 (`Al`) では色トークンを記述順に消費し、足りなくなったら先頭に戻って繰り返す。`Fl(2+1) W G` のような複合カウントは「白を 2 回点滅 → 緑を 1 回点滅」という順番を意味する。`Dir` は方位ごとに固定色を割り当てるため、常にセクター色解釈になる。
- `Oc`（明暗灯）は原則として単色で使用する。複数色を交互に見せたい場合は `Al Oc` に分解し、方位による色分けは `Dir` + `arcs` で表現する。

## データ仕様（`arcs` / `range` / 正規化）

- **方位系:** `arcs` の `start` は真北を 0° とし、時計回りで増加する。`start` は包含、`end` は排他的（`[start, end)`）とし、360° を跨ぐ場合は `start > end` の形（例: `{ start: 300, end: 60 }`）で記述する。
- **色単位:** `arcs.color` は単色トークン（`W`, `R`, `G`, `Y`, `Am` など）で記述し、混色は描画側でハイライト合成する。`Dir` で複数色を扱う場合は、色ごとに別エントリへ分割する。
- **射程 (`range`):** 単位は海里（NM）。全色共通なら数値、色別に異なる場合は `{ W: 14, R: 10, G: 11 }` のようなオブジェクトを許容する。
- **コード正規化:** 入力時に前後の空白を削除し、連続空白を単一スペースに圧縮、大文字化して判定する。`GpFl` は自動で `Gp Fl` に挿入され、`VQ`, `vq`, `Vq` のような表記揺れも同一視される。

## タイプ別の挙動

| Type | 概要 | タイミングの計算 |
| --- | --- | --- |
| `Fl` / `Fl(n)` | 点滅灯。任意の `n` で 1 周期の発光回数を指定。 | 周期を `max(n, colorCount)` で割ってスロット長を算出。各スロットは 60% が点灯、残りが消灯（最小 0.05 秒、最大 0.3 秒にクランプ）。 |
| `Al` / `Al(n)` | 交互点滅。`Al Fl ...` は交互フラッシュ、`Al Iso ...` は交互等明暗灯、`Al Oc ...` は交互明暗灯を表す。 | スロット長は `period / alternationCount`（`n` 無指定なら `colorCount` を使用）。`Fl(2+1)` のような内部表記がある場合は 1 セットを 1 スロットとして扱い、色のまとまり単位で順番を進めます。各スロットは `gap = min(slot * 0.1, 0.2)` 秒の消灯を挟んで点灯時間を `slot - gap` とする。 |
| `Dir` | `Dir F W R G` のような指向灯。 | 各色は同時に存在し、`lighthousesData.js` 側の `arcs` の方位と結び付けられて表示される。周期や順番の概念はなく、指定した色をそのまま可視化に用いる（周期指定は任意）。 |
| `F` | 不動光（常時点灯）。 | 常に点灯状態を維持し、`arcs` があれば該当方向に静的表示される。周期を省略した場合は無限長として扱う。 |
| `FFl` / `Fl F` | 不動光に閃光を重畳。 | `F` の連続点灯をベースに、`Fl` と同じスロット計算で瞬間的な閃光を重ねる。点灯比率は `Fl` を優先し、非点灯時間でも `F` 成分は光り続ける。 |
| `Gp Fl` | 群閃。`Gp Fl(3)` などでグループ内の閃光数を指定。 | `Fl(n)` と同じ計算でスロットを区切りつつ、グループ内の閃光をまとめて 1 セットとして扱う。セット間には 1〜2 スロット長ぶんの暗期を挿入し（既定 1 スロット）、群構造を視認しやすくする。 |
| `Gp Oc` / `Oc(n)` | 群明暗。`Gp Oc(3)` や `Oc(2)` のように減光を束ねる。 | `Oc` の 25%/75% 比率を保ちながら、`Fl(n)` 同様にカウントぶんスロットを生成し、セットごとに暗期を `slotLength`〜`2 * slotLength`（既定 1 スロット）で挿入する。 |
| `LFl` | 長閃光。通常の Fl より点灯時間が長い。 | 1 スロットの点灯比率を 70〜90% の範囲で許容し、既定値は 80%。残りを消灯時間として扱う。 |
| `Mo` | モールス符号灯（例: `Mo(A)`）。 | カウント部に文字列が入る場合があり、指定記号のモールス長短をシーケンス化して点滅させる。 |
| `Oc` | 明暗灯（減光灯）。原則単色で使用。 | 周期の 25% が点灯、75% が消灯。複数色を交互に扱う場合は `Al Oc` で定義する。 |
| `Q` / `VQ` / `UQ` / `IQ` | 高頻度点滅。Q=Quick (~1Hz)、VQ=Very Quick (~2Hz)、UQ=Ultra Quick (~4Hz)、IQ=Interrupted Quick。 | 1 スロットの長さをタイプに応じて短縮し（Q≈1s、VQ≈0.5s、UQ≈0.25s）、`Fl` と同じ 60% 点灯比率で連続発光させる。`IQ` はグループの最後に 3〜5 スロットぶんの長め暗期を追加する。 |
| `Iso` | 等明暗灯。 | 周期を等しく 50%/50% で点灯・消灯。 |

## Mo（モールス）タイミングの詳細

- `Mo(<symbol>)` の `<symbol>` は英数字や括弧内の記号で、定義済みのモールス辞書（実装上は `src/morse.js`）を参照してドット／ダッシュ列に展開する。`Mo(A)` は `・－`、`Mo(UD)` は `・・－・・` のように連結される。
- ドットを 1 単位、ダッシュを 3 単位とし、文字内の要素間隔は 1 単位、文字間隔は 3 単位、語間隔は 7 単位の暗期を挿入する。
- 周期全体を辞書列の総単位数で割って 1 単位あたりの時間を算出し、指定された色でオン／オフを切り替える。周期が不足する場合は 1 単位あたりの時間を最小 0.05 秒までクランプする。

> **補足:** 単体のシミュレーターとポップアップは同じ解析ロジックを共有しているため、UI 全体で挙動は統一されている。

## エラーハンドリング

- 認識できないタイプや色トークンだけのコードはエラーを出さず、灯火を消灯したままにする。
- 周期値が解釈できない、または 0 以下の場合は点灯シミュレーションを実行できない。
- 余分な空白は自動的に無視される。

## 参考例

| Code | 解釈 |
| --- | --- |
| `Fl W 4s` | 4 秒ごとに白色が 1 回点滅。 |
| `Fl(2) W 10s` | 10 秒周期で短い白色の点滅が連続 2 回。 |
| `Fl W R 5s` | 白と赤を同時に発光（表示上はオレンジ）。 |
| `Fl(2+1) W G 12s` | 白を 2 回点滅したあと緑を 1 回点滅し、合計 12 秒周期で繰り返す。 |
| `Al Fl(2+1) W G 18s` | 交互フラッシュで白×2 → 緑×1 のセットを 18 秒周期で繰り返す。 |
| `Al Fl W G 8.6s` | 8.6 秒周期で白→緑を交互に点灯（例: 羽田空港灯台）。 |
| `Al Iso W G 6s` | 等明暗パターンを交互に切り替え、白→緑を 6 秒周期で示す。 |
| `Al Oc W R 10s` | 明暗シーケンスを交互に切り替え、白と赤を 10 秒周期で表示。 |
| `FFl W 10s` | 白色の不動光に 10 秒周期の閃光が重畳する沿岸灯の典型。 |
| `F W` | 白の不動光。常時点灯。 |
| `Gp Fl(3) W 15s` | 白色の三連群閃を 15 秒周期で繰り返す。 |
| `Gp Oc(3) R 12s` | 赤の明暗を 3 回まとめた群明暗で、セット間に長めの暗期。 |
| `LFl W 10s` | 白色の長閃光を 10 秒周期で繰り返す。 |
| `Mo(A) W 6s` | 白色でモールス符号「A」を 6 秒周期で送る。 |
| `Q W` | 1 秒周期前後で白を高速点滅させる（クイック）。 |
| `VQ(3) G 10s` | 10 秒周期で緑色のベリークイック点滅を 3 連続させる。 |
| `IQ Y 15s` | 黄灯のクイック点滅を数回行い、周期末に長い暗期を入れる。 |
| `Dir F W R G` | 白・赤・緑の固定セクターを持つ指向灯（例: 須崎恵比須島指向灯）。 |
| `Oc G 6s` | 緑色の明暗灯。1.5 秒点灯・4.5 秒消灯。 |
| `Iso R 4s` | 赤色の等明暗灯。2 秒点灯・2 秒消灯。 |

以下はセクター色として扱う `Fl W R 10s` のデータ例です。`arcs` を与えることで、同じコードでも混色ではなく方位別の固定色としてレンダリングされます。

```jsonc
{
	"code": "Fl W R 10s",
	"arcs": [
		{ "start": 340, "end": 120, "color": "W" },
		{ "start": 120, "end": 220, "color": "R" }
	],
	"range": { "W": 14, "R": 10 }
}
```
