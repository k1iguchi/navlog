# NAVLOG YAMLフォーマット

このドキュメントでは、`navlog` アプリケーションが生成・読み込みを行う YAML データの構造、項目一覧、注意点を整理します。YAML は航法ログの保存・復元に利用でき、フォームと双方向に同期されます。

## 概要

- **トップレベル要素**
  - `title`: 画面上部に表示するナビゲーションログのタイトル文字列。
  - `departure`: 出発地に関する入力値を保持するオブジェクト。
  - `checkpoints`: 各レグ（チェックポイント）を表すオブジェクトの配列。
- **省略ルール**: 空欄のフィールドは YAML から除外されます。値が入力されていない項目はパース時にも自動入力されません。
- **データ型**: フォーム上で数値入力欄 (`input[type="number"]`) の項目は数値として出力され、それ以外は文字列として出力されます。
- **計算項目**: 方位・速度など自動計算されるフィールドは YAML には含まれません（例外あり、後述）。再読み込み時はアプリ側で再計算されます。

### トップレベル構造の例

```yaml
title: "東京湾沿岸 VFR"  # 未指定の場合は既定で「VFR ナビゲーションログ」を表示
departure:
  departure: RJTT
  rmk: "Fuel on board 3.5h"
checkpoints:
  - pointType: "変針点"
    name: "RJTQ"
    altitude: 4500
    tas: 110
    windDir: 240
    windSpeed: 15
    tc: 090
    var: 8
    dev: 0
    distance: 38
    legEte: 21
    vor: 113.8
    vorSign: QCH
    rmk: "Maintain 4500ft"
  - pointType: "CP"
    name: "CHK-02"
    altitude: 4500
    tas: 110
    tc: 135
    distance: 24
    legEte: 13
```

## `title` フィールド

| フィールド | 型 | 説明 |
| :-- | :-- | :-- |
| `title` | 文字列 | 画面上部に表示されるドキュメントタイトル。空文字の場合も YAML には空文字として保存されます。未指定で新規作成した場合は「VFR ナビゲーションログ」が初期値として表示されます。|

> メモ: `title` はトップレベルに単独で存在するフィールドです。出発地とチェックポイント情報は従来通り各セクションに含まれます。

## `departure` セクション

| フィールド | 型 | 説明 |
| :-- | :-- | :-- |
| `departure` | 文字列 | 出発地名称または識別子。任意のテキスト。 |
| `rmk` | 文字列 | 備考欄。複数行テキスト対応。 |

> メモ: 出発地セクションには `yamlUtils.js` の実装上、この 2 項目のみが含まれます。

## `checkpoints` セクション

各要素は 1 行分の入力値を表します。フォーム上で値が入力された項目のみ YAML に出現します。

| フィールド | 型 | 入力元 | 説明 |
| :-- | :-- | :-- | :-- |
| `pointType` | 文字列 | セレクトボックス | `"変針点"` または `"CP"`。区切り行の判定に使用。 |
| `name` | 文字列 | テキスト | 地点名または通過点識別子。 |
| `altitude` | 数値 | 数値入力 | フィート単位の飛行高度。 |
| `tas` | 数値 | 数値入力 | True Air Speed (kt)。 |
| `windDir` | 数値 | 数値入力 | 風向 (度)。未入力の場合、自動計算では 0° とみなされます。 |
| `windSpeed` | 数値 | 数値入力 | 風速 (kt)。未入力の場合、自動計算では 0kt。 |
| `tc` | 数値 | 数値入力 | True Course (度)。 |
| `var` | 数値 | 数値入力 (初期値 8) | 磁針方位差 (VAR)。既定値 8°W。 |
| `dev` | 数値 | 数値入力 (初期値 0) | コンパス偏差 (DEV)。既定値 0°。 |
| `distance` | 数値 | 数値入力 | 区間距離 (nm)。 |
| `ete` | — | 自動計算 | YAML には出力されません。アプリ再計算に依存。 |
| `legEte` | 数値 | 自動計算 | 現行実装では YAML に出力されます。読み込み時にフォームへ再設定され、合計計算で上書きされます。 |
| `vor` | 文字列 | テキスト | VOR 周波数 (MHz)。フォーマット制約なし。 |
| `vorSign` | 文字列 | テキスト | VOR 識別符号。モールス表示と連動。 |
| `rmk` | 文字列 | テキストエリア | 備考。複数行対応。 |

### 自動計算され YAML から除外される主なフィールド

- `wca` (風向修正角)
- `th` (真針路)
- `mh` (磁針路)
- `ch` (実用方位)
- `gs` (地上速度)
- `remDist` (残距離)
- `legDistance` (区間総距離)

これらは YAML に含まれず、読み込み時に再計算されます。

### 非対応フィールド

- `fuel` 列は現状 UI 上でも入力欄がないため YAML には出現しません。
- `eta` 列は表示用ラベルのみで、入力できません。

## YAML を編集・適用する際のヒント

1. アプリで入力後、`YAML` テキストエリアの内容をコピーして保存してください。
2. 外部で編集する場合、トップレベルの `departure` と `checkpoints` 構造を維持します。
3. 数値フィールドに文字列を入れると読み込み後の再計算で想定外の挙動になる可能性があります。
4. YAML をペーストしてフォームに読み込むと、各行の計算が再実行されます。`legEte` のような計算値を手動で編集した場合は、再計算で上書きされる点に注意してください。

## 既知の挙動

- `legEte` は自動計算値ですが除外リストに含まれていないため、現状 YAML に残ります。計算値のみを保存したくない場合は YAML から該当キーを手動で削除してください（読み込み後に再計算されます）。
- `pointType` を省略すると既定で `"変針点"` とみなされません。配列要素ごとに明示することを推奨します。

## 参考

- YAML との同期処理は `src/yamlUtils.js` に実装されています。
- フォーム列の詳細は `src/columns.js` を参照してください。
